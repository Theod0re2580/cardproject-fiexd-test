<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>혜택별 카드 추천</title>

    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <style>
        /* --------------------------------------
   전체 기본 스타일
---------------------------------------*/
        body {
            font-family: 'Pretendard Variable','Segoe UI',sans-serif;
            margin: 0;
            opacity: 0;
            transition: .6s;
        }

        body.loaded {
            opacity: 1;
        }

        /* 제목 */
        h1 {
            text-align: center;
            color: #121212;
            margin-bottom: 35px;
            font-size: 34px;
            font-weight: 700;
        }

        /* --------------------------------------
           검색창
        ---------------------------------------*/
        form {
            text-align: center;
            margin-bottom: 25px;
        }

        form input[type=text] {
            padding: 12px 18px;
            width: 300px;
            border-radius: 30px;
            border: 1.5px solid #d4d7e2;
            font-size: 15px;
            outline: none;
            transition: .2s;
            background: white;
        }

        form input[type=text]:focus {
            border-color: #5773ff;
            box-shadow: 0 0 0 4px rgba(87,115,255,0.15);
        }

        form button {
            padding: 12px 25px;
            background: #5773ff;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            transition: .25s;
        }

        form button:hover {
            background: #4456d4;
        }

        /* --------------------------------------
           혜택 카테고리 버튼
        ---------------------------------------*/
        .benefit-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin: 35px 0;
        }

        .benefit-buttons button {
            background: #e8ecf8;
            border: none;
            padding: 8px 18px;
            color: #4b5bc7;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.25s ease;
        }

        .benefit-buttons button:hover {
            background: #d7dcf7;
        }

        .benefit-buttons button.active {
            background: #5866f7;
            color: white;
            font-weight: 600;
        }

        /* --------------------------------------
           카드 리스트 레이아웃
        ---------------------------------------*/
        .card-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 26px;
            padding-bottom: 60px;
        }

        /* --------------------------------------
           카드 디자인
        ---------------------------------------*/
        .card {
            background: white;
            width: 290px;
            padding: 20px;
            border-radius: 18px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            display: none;
            transition: 0.3s ease;
            border: 1px solid #eef0f7;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }

        /* 카드 이미지 */
        .card img {
            width: 100%;
            height: 160px;
            object-fit: contain;
            margin-bottom: 15px;
        }

        /* 카드 이름 */
        .card h3 {
            font-size: 20px;
            font-weight: 600;
            color: #111;
            margin-bottom: 6px;
        }

        /* 브랜드 */
        .card p {
            font-size: 15px;
            color: #555;
            margin: 2px 0 6px 0;
        }

        /* --------------------------------------
           혜택 영역
        ---------------------------------------*/
        .benefit-block {
            background: #f8faff;
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 10px;
            max-height: 140px;
            overflow: hidden;
            transition: max-height .3s ease;
            border: 1px solid #e1e7ff;
        }

        .benefit-block.expanded {
            max-height: 2000px;
        }

        .benefit-block p {
            margin: 3px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        /* 혜택 이름 강조 */
        .benefit-block strong {
            color: #4158d0;
            font-size: 15px;
        }

        /* 더보기 버튼 */
        .toggle-btn {
            cursor: pointer;
            color: #4158d0;
            font-weight: 600;
            font-size: 14px;
            margin-top: 6px;
            display: inline-block;
        }

        /* --------------------------------------
           더보기 버튼
        ---------------------------------------*/
        .load-more {
            display: none;
            margin: 30px auto;
            padding: 12px 32px;
            background: #424242;
            color: white;
            border-radius: 26px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: .25s;
        }

        .load-more:hover {
            background: #2c2c2c;
        }

        /* --------------------------------------
           반응형
        ---------------------------------------*/
        @media (max-width: 768px) {
            .card { width: 85%; }
        }

        @media (max-width: 480px) {
            form input[type=text] { width: 70%; }
            .card { width: 92%; }
        }

    </style>
</head>

<body>
<div th:replace="events/header :: header"></div>
<h1>혜택별 카드 추천</h1>

<form action="/events/benefits" method="get">
    <input type="text" name="keyword" placeholder="예: 커피, 주유, 교통" th:value="${keyword}">
    <button type="submit">검색</button>
</form>

<div class="benefit-buttons" id="benefitButtons"></div>

<div class="card-list" id="cardList">

    <div class="card" th:each="ev : ${events}" th:data-categories="${ev.categoryString}">

        <!-- ★ 이미지 파싱 오류 방지: 삼항 연산 완전 안전 버전 -->
        <img th:src="${ev.card.cardImg != null && ev.card.cardImg != '' ? ev.card.cardImg : '/images/bono.png'}"
             onerror="this.src='/images/bono.png'">

        <h3 th:text="${ev.card.cardName}"></h3>

        <p th:text="'브랜드: ' + ${ev.card.cardBrand}"></p>

        <div class="benefit-block">
            <div th:each="b : ${ev.benefits}">
                <p><strong th:text="${b.bnfName}"></strong></p>
                <p th:text="${b.bnfContent}"></p>
                <p th:text="${b.bnfDetail}"></p>
                <br>
            </div>
        </div>

        <span class="toggle-btn" onclick="toggleBlock(this)">더보기</span>
    </div>

</div>

<button id="loadMoreBtn" class="load-more">카드 더보기</button>

<div th:replace="events/footer :: footer"></div>

<!-- ★ Thymeleaf 파싱 오류 완전 방지: JSON Safe 방식 -->
<script th:inline="javascript">
    const events = [[${events}]];
</script>

<script>
    window.addEventListener("load", () => {
        document.body.classList.add("loaded");

        const cards = [...document.querySelectorAll(".card")];
        const loadBtn = document.getElementById("loadMoreBtn");
        const btnArea = document.getElementById("benefitButtons");

        let active = new Set();

        /* 카테고리 */
        const rawCategories = new Set(
            events.flatMap(ev => (ev.categoryString || "").split(","))
        );
        const categoryList = [...rawCategories].sort();

        categoryList.forEach(cat => {
            const btn = document.createElement("button");
            btn.textContent = cat;

            btn.onclick = () => {
                if (active.has(cat)) {
                    active.delete(cat);
                    btn.classList.remove("active");
                } else {
                    active.add(cat);
                    btn.classList.add("active");
                }
                filterCards();
            };

            btnArea.appendChild(btn);
        });

        let visibleCards = [];
        let loadedCount = 0;

        function filterCards() {
            const keywords = [...active];
            visibleCards = [];

            cards.forEach(c => {
                const cats = (c.dataset.categories || "").split(",").filter(x => x);
                const match = keywords.length === 0 || keywords.some(k => cats.includes(k));

                if (match) visibleCards.push(c);
                c.style.display = "none";
            });

            loadedCount = 0;
            loadMore();
        }

        function loadMore() {
            const next = visibleCards.slice(loadedCount, loadedCount + 10);

            next.forEach(c => c.style.display = "block");
            loadedCount += next.length;

            loadBtn.style.display = loadedCount >= visibleCards.length ? "none" : "block";
        }

        loadBtn.onclick = loadMore;

        filterCards();
    });

    function toggleBlock(btn) {
        const box = btn.previousElementSibling;
        box.classList.toggle("expanded");
        btn.textContent = box.classList.contains("expanded") ? "접기" : "더보기";
    }
</script>

</body>
</html>
