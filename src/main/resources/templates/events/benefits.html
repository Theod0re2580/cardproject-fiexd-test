<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>í˜œíƒë³„ ì¹´ë“œ ì¶”ì²œ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 40px;
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
        }
        body.loaded { opacity: 1; }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        form {
            text-align: center;
            margin-bottom: 20px;
        }

        input[type="text"] {
            padding: 10px;
            width: 250px;
            border-radius: 20px;
            border: 1px solid #aaa;
        }

        button {
            padding: 10px 20px;
            border: none;
            background-color: #667eea;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        button:hover { background-color: #5a67d8; }

        /* ëª¨ë“œ ì „í™˜ ë²„íŠ¼ */
        .mode-toggle {
            text-align: center;
            margin-bottom: 25px;
        }

        .mode-toggle button {
            background: #444;
            padding: 8px 15px;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            border: none;
            font-size: 0.9em;
            transition: 0.3s;
        }

        .mode-toggle button:hover { background: #222; }

        /* í˜œíƒ ë²„íŠ¼ */
        .benefit-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin: 25px 0;
        }

        .benefit-buttons button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .benefit-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.25);
        }

        .benefit-buttons button.active {
            background: #ff7f50;
        }

        /* ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ */
        .card-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 260px;
            padding: 15px;
            text-align: center;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .card img {
            width: 100%;
            height: 150px;
            object-fit: contain;
        }

        h3 { margin: 10px 0; color: #222; }
        p { margin: 4px 0; color: #555; font-size: 0.9em; }

        /* í˜œíƒ ìƒì„¸ */
        .bnfDetail {
            max-height: 50px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            font-size: 0.85em;
            color: #444;
            text-align: left;
            white-space: pre-line;
        }

        .bnfDetail.expanded { max-height: 500px; }

        .toggle-btn {
            cursor: pointer;
            color: #2575fc;
            font-weight: bold;
            font-size: 0.9em;
            margin-top: 5px;
            display: inline-block;
        }

        /* ì¹´ë“œ ë”ë³´ê¸° ë²„íŠ¼ */
        .load-more {
            display: none;
            margin: 25px auto;
            padding: 10px 25px;
            background-color: #444;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: 0.3s;
        }

        .load-more:hover { background-color: #222; }
    </style>
</head>
<body>
<h1>ğŸ¯ í˜œíƒë³„ ì¹´ë“œ ì¶”ì²œ</h1>

<form action="/events/benefits" method="get">
    <input type="text" name="keyword" placeholder="ì˜ˆ: ì»¤í”¼, ì£¼ìœ , êµí†µ" th:value="${keyword}">
    <button type="submit">ê²€ìƒ‰</button>
</form>

<div class="mode-toggle">
    <button id="modeBtn">í˜„ì¬ ëª¨ë“œ: OR</button>
</div>

<div class="benefit-buttons" id="benefitButtons"></div>

<div class="card-list" id="cardList">
    <div class="card" th:each="ev : ${events}" th:data-bnf="${ev.benefit.bnfName}">
        <img th:src="${ev.card.cardImg != '' ? ev.card.cardImg : '/images/bono.png'}"
             onerror="this.onerror=null;this.src='/images/bono.png';"
             alt="card image">
        <h3 th:text="${ev.card.cardName}"></h3>
        <p th:text="'ë¸Œëœë“œ: ' + ${ev.card.cardBrand}"></p>
        <p th:text="${ev.benefit.bnfContent}"></p>
        <p class="bnfDetail" th:text="${ev.benefit.bnfDetail}"></p>
        <span class="toggle-btn" onclick="toggleDetail(this)">ë”ë³´ê¸°</span>
    </div>
</div>

<!-- âœ… ì¹´ë“œ ë”ë³´ê¸° ë²„íŠ¼ -->
<button id="loadMoreBtn" class="load-more">ì¹´ë“œ ë”ë³´ê¸°</button>

<script th:inline="javascript">
    window.addEventListener('load', () => {
        document.body.classList.add('loaded');

        const events = /*[[${events}]]*/ [];
        const container = document.getElementById('benefitButtons');
        const modeBtn = document.getElementById('modeBtn');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        let filterMode = 'OR';
        const activeBenefits = new Set();

        // âœ… í˜œíƒ ì´ë¦„ í•„í„°ë§ (5ê¸€ì ì´í•˜ + ìˆ«ì ì—†ìŒ)
        const bnfNames = [...new Set(events
            .map(ev => ev.benefit?.bnfName)
            .filter(name => name && name.length <= 5 && !/\d/.test(name))
        )].sort();

        // âœ… ëª¨ë“œ ì „í™˜
        modeBtn.addEventListener('click', () => {
            filterMode = filterMode === 'OR' ? 'AND' : 'OR';
            modeBtn.innerText = `í˜„ì¬ ëª¨ë“œ: ${filterMode}`;
            applyFilter();
        });

        // âœ… ë²„íŠ¼ ìƒì„±
        bnfNames.forEach(name => {
            const btn = document.createElement('button');
            btn.textContent = name;
            btn.addEventListener('click', () => {
                if (activeBenefits.has(name)) {
                    activeBenefits.delete(name);
                    btn.classList.remove('active');
                } else {
                    activeBenefits.add(name);
                    btn.classList.add('active');
                }
                applyFilter();
            });
            container.appendChild(btn);
        });

        // âœ… 20ê°œì”© ë‹¨ê³„ì  ë”ë³´ê¸°
        function applyFilter() {
            const activeArray = [...activeBenefits];
            const cards = Array.from(document.querySelectorAll('.card'));

            // ë§¤ì¹­ëœ ì¹´ë“œ ê³„ì‚°
            const matchedCards = cards.filter(card => {
                const bnf = card.dataset.bnf || "";
                if (activeArray.length === 0) return true;
                return filterMode === 'OR'
                    ? activeArray.some(keyword => bnf.includes(keyword))
                    : activeArray.every(keyword => bnf.includes(keyword));
            });

            // ì´ˆê¸°í™”
            cards.forEach(c => c.style.display = 'none');

            const batchSize = 20;
            let currentCount = 0;

            function showNextBatch() {
                const nextBatch = matchedCards.slice(currentCount, currentCount + batchSize);
                nextBatch.forEach(card => card.style.display = 'block');
                currentCount += batchSize;

                if (currentCount >= matchedCards.length) {
                    loadMoreBtn.style.display = 'none';
                } else {
                    loadMoreBtn.style.display = 'block';
                }
            }

            if (matchedCards.length > 0) showNextBatch();

            loadMoreBtn.onclick = showNextBatch;

            if (matchedCards.length <= batchSize) {
                loadMoreBtn.style.display = 'none';
            }
        }

        applyFilter(); // ì´ˆê¸° ì ìš©
    });

    // âœ… í˜œíƒ ìƒì„¸ ë”ë³´ê¸°
    function toggleDetail(btn) {
        const detail = btn.previousElementSibling;
        if (detail.classList.contains('expanded')) {
            detail.classList.remove('expanded');
            btn.innerText = 'ë”ë³´ê¸°';
        } else {
            detail.classList.add('expanded');
            btn.innerText = 'ì ‘ê¸°';
        }
    }
</script>
</body>
</html>


