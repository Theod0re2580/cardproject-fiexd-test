CREATE TABLE USERS (
                       user_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       username VARCHAR2(100) NOT NULL,
                       user_email VARCHAR2(150) UNIQUE NOT NULL,
                       user_pw VARCHAR2(200) NOT NULL,
                       birth DATE,
                       gender CHAR(1) CHECK (gender IN ('M','F')),
                       created_at DATE DEFAULT SYSDATE -- 삭제 요망
); -- 사용자 테이블

CREATE TABLE ORG_INFO (
                          org_code VARCHAR2(10) PRIMARY KEY, -- 삭제 및 name과 병합
                          org_name VARCHAR2(100) NOT NULL, -- 병합
                          contact_info VARCHAR2(100),
                          homepage VARCHAR2(200)
); -- 카드사 정보

CREATE TABLE CARDS (
                       card_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                       user_id NUMBER REFERENCES USERS(user_id) ON DELETE CASCADE,
                       org_code VARCHAR2(10) REFERENCES ORG_INFO(org_code),
                       card_name VARCHAR2(200) NOT NULL,
                       card_type VARCHAR2(2) CHECK (card_type IN ('01','02','03')), -- 01:신용, 02:체크, 03:소액신용 3번 삭제
                       card_member CHAR(1) CHECK (card_member IN ('1','2')),         -- ( 1:본인, 2:가족 )삭제
                       reg_date DATE DEFAULT SYSDATE -- 삭제
); -- 카드 정보

CREATE TABLE CARD_BENEFIT (
                              benefit_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                              card_id NUMBER NOT NULL REFERENCES CARDS(card_id) ON DELETE CASCADE,
                              benefit_type VARCHAR2(10) CHECK (benefit_type IN ('할인', '적립')),
                              category VARCHAR2(100) NOT NULL,
                              rate NUMBER(5,2) NOT NULL,
                              max_limit NUMBER(10,0),
                              description VARCHAR2(300)
); -- 카드 혜택

CREATE TABLE CARD_RECOMMEND_LOG (
                                    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                    user_id NUMBER NOT NULL REFERENCES USERS(user_id) ON DELETE CASCADE,
                                    card_id NUMBER REFERENCES CARDS(card_id),
                                    reason VARCHAR2(300),
                                    match_score NUMBER(5,2),
                                    recommended_at DATE DEFAULT SYSDATE
); --추천 이력

INSERT INTO USERS (username, user_email, user_pw, birth, gender)
VALUES ('김철수', 'chulsoo@example.com', 'pw1234', DATE '1990-05-10', 'M');
INSERT INTO USERS (username, user_email, user_pw, birth, gender)
VALUES ('이영희', 'younghee@example.com', 'pw1234', DATE '1995-11-20', 'F');
INSERT INTO USERS (username, user_email, user_pw, birth, gender)
VALUES ('박민수', 'minsu@example.com', 'pw1234', DATE '1988-03-15', 'M');
INSERT INTO USERS (username, user_email, user_pw, birth, gender)
VALUES ('정수진', 'sujin@example.com', 'pw1234', DATE '1992-09-25', 'F');
INSERT INTO USERS (username, user_email, user_pw, birth, gender)
VALUES ('최다혜', 'dahye@example.com', 'pw1234', DATE '1998-01-30', 'F');

INSERT INTO ORG_INFO (org_code, org_name, contact_info, homepage)
VALUES ('KB', 'KB국민카드', '1588-1688', 'https://card.kbcard.com');
INSERT INTO ORG_INFO (org_code, org_name, contact_info, homepage)
VALUES ('SS', '삼성카드', '1588-8700', 'https://www.samsungcard.com');
INSERT INTO ORG_INFO (org_code, org_name, contact_info, homepage)
VALUES ('HN', '현대카드', '1577-6000', 'https://www.hyundaicard.com');
INSERT INTO ORG_INFO (org_code, org_name, contact_info, homepage)
VALUES ('LO', '롯데카드', '1588-8100', 'https://www.lottecard.co.kr');
INSERT INTO ORG_INFO (org_code, org_name, contact_info, homepage)
VALUES ('SH', '신한카드', '1544-7000', 'https://www.shinhancard.com');

INSERT INTO CARDS (user_id, org_code, card_name, card_type, card_member)
VALUES (1, 'KB', 'KB국민 청춘대로 카드', '01', '1');
INSERT INTO CARDS (user_id, org_code, card_name, card_type, card_member)
VALUES (2, 'SS', '삼성 iD ENERGY 카드', '02', '1');
INSERT INTO CARDS (user_id, org_code, card_name, card_type, card_member)
VALUES (3, 'HN', '현대 ZERO Edition2', '01', '2');
INSERT INTO CARDS (user_id, org_code, card_name, card_type, card_member)
VALUES (4, 'LO', '롯데 DC카드', '03', '1');
INSERT INTO CARDS (user_id, org_code, card_name, card_type, card_member)
VALUES (5, 'SH', '신한 Deep Dream 카드', '01', '1');

INSERT INTO CARD_BENEFIT (card_id, benefit_type, category, rate, max_limit, description)
VALUES (1, '적립', '편의점', 5.0, 20000, 'CU, GS25에서 5% 적립');
INSERT INTO CARD_BENEFIT (card_id, benefit_type, category, rate, max_limit, description)
VALUES (2, '할인', '주유', 3.0, 30000, '주유소 리터당 60원 할인');
INSERT INTO CARD_BENEFIT (card_id, benefit_type, category, rate, max_limit, description)
VALUES (3, '적립', '커피', 10.0, 10000, '스타벅스, 이디야 10% 적립');
INSERT INTO CARD_BENEFIT (card_id, benefit_type, category, rate, max_limit, description)
VALUES (4, '할인', '영화', 20.0, 15000, 'CGV, 롯데시네마 20% 할인');
INSERT INTO CARD_BENEFIT (card_id, benefit_type, category, rate, max_limit, description)
VALUES (5, '적립', '대중교통', 7.0, 25000, '버스, 지하철 7% 적립');

INSERT INTO CARD_RECOMMEND_LOG (user_id, card_id, reason, match_score)
VALUES (1, 5, '대중교통 이용 빈도 높음', 95.0);
INSERT INTO CARD_RECOMMEND_LOG (user_id, card_id, reason, match_score)
VALUES (2, 1, '편의점 소비가 많음', 88.5);
INSERT INTO CARD_RECOMMEND_LOG (user_id, card_id, reason, match_score)
VALUES (3, 4, '영화관 자주 이용', 90.0);
INSERT INTO CARD_RECOMMEND_LOG (user_id, card_id, reason, match_score)
VALUES (4, 3, '카페 소비가 잦음', 85.0);
INSERT INTO CARD_RECOMMEND_LOG (user_id, card_id, reason, match_score)
VALUES (5, 2, '주유소 이용 패턴', 92.0);

SELECT * FROM CARD;
SELECT * FROM BENEFIT;
SELECT * FROM MEMBER;

SELECT column_name FROM user_tab_columns WHERE table_name = 'CARD';

SELECT * FROM MEMBER WHERE USER_ID = 'admin';

-- ⚠️ 모든 테이블 삭제 (외래키 순서 고려)
BEGIN
FOR t IN (SELECT table_name FROM user_tables) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
END LOOP;
END;
/

DROP TABLE CARD_BENEFIT CASCADE CONSTRAINTS;
DROP TABLE CARD CASCADE CONSTRAINTS;
DROP TABLE BENEFIT CASCADE CONSTRAINTS;
DROP TABLE EVENT CASCADE CONSTRAINTS;
DROP TABLE MEMBER CASCADE CONSTRAINTS;

ALTER SESSION SET NLS_LANGUAGE = 'KOREAN';
ALTER SESSION SET NLS_TERRITORY = 'KOREA';

SELECT table_name FROM user_tables WHERE table_name IN ('CARD', 'BENEFIT');

DROP TABLE card;
DROP TABLE benefit;

CREATE TABLE CARD (
                      id            VARCHAR2(50) CONSTRAINT pk_card PRIMARY KEY,
                      card_name     VARCHAR2(200) CONSTRAINT nn_card_name NOT NULL,
                      card_brand    VARCHAR2(100),
                      card_in_out1  VARCHAR2(100),
                      card_in_out2  VARCHAR2(100),
                      card_in_out3  VARCHAR2(100),
                      card_img      VARCHAR2(500),
                      card_record   NUMBER DEFAULT 0,
                      card_overseas VARCHAR2(200)
);

CREATE TABLE BENEFIT (
                         id           VARCHAR2(50) CONSTRAINT pk_benefit PRIMARY KEY,
                         bnf_name     VARCHAR2(200) CONSTRAINT nn_bnf_name NOT NULL,
                         bnf_content  VARCHAR2(1000),
                         bnf_detail   VARCHAR2(2000),
                         card_id      VARCHAR2(50) CONSTRAINT nn_card_id NOT NULL,
                         CONSTRAINT fk_benefit_card FOREIGN KEY (card_id)
                             REFERENCES CARD (id)
                             ON DELETE CASCADE
);

CREATE INDEX idx_card_brand
    ON CARD (card_brand);

CREATE INDEX idx_benefit_card_id
    ON BENEFIT (card_id);

CREATE INDEX idx_benefit_name
    ON BENEFIT (bnf_name);

-- 테이블 존재 여부
SELECT table_name FROM user_tables WHERE table_name IN ('CARD', 'BENEFIT');

-- PK/FK 제약조건 확인
SELECT constraint_name, constraint_type, table_name
FROM user_constraints
WHERE table_name IN ('CARD', 'BENEFIT');

-- 현재 데이터 개수
SELECT COUNT(*) FROM CARD;
SELECT COUNT(*) FROM BENEFIT;

ALTER TABLE BENEFIT MODIFY (id VARCHAR2(150));
ALTER TABLE CARD MODIFY (id VARCHAR2(150));
ALTER TABLE BENEFIT MODIFY (card_id VARCHAR2(150));

COMMIT;

SELECT b."card_id" FROM BENEFIT b LEFT JOIN CARD c ON b."card_id" = c."id" WHERE c."id" IS NULL;

ALTER TABLE BENEFIT ADD CONSTRAINT fk_benefit_card FOREIGN KEY ("card_id") REFERENCES CARD("id") ON DELETE CASCADE;

SELECT constraint_name, constraint_type
FROM user_constraints
WHERE table_name = 'CARD';

ALTER TABLE CARD
    ADD CONSTRAINT pk_card PRIMARY KEY ("id");

SELECT constraint_name, constraint_type, table_name
FROM user_constraints
WHERE table_name IN ('CARD', 'BENEFIT');

SELECT c."card_name", b."bnf_name", b."bnf_content"
FROM CARD c
         JOIN BENEFIT b ON c."id" = b."card_id"
WHERE c."id" = 1;

SELECT * FROM CARD c ;
SELECT * FROM BENEFIT b ;

SELECT *
FROM card
WHERE "card_brand" LIKE '%BC%';

SELECT * FROM card WHERE "card_brand" LIKE '%KDB%';
SELECT * FROM card WHERE "card_brand" LIKE 'MG%';
SELECT * FROM card WHERE "card_brand" LIKE 'NH%';

SELECT COLUMN_NAME FROM USER_TAB_COLUMNS WHERE TABLE_NAME='CARD';
SELECT column_name
FROM user_tab_columns
WHERE table_name = 'CARD'
ORDER BY column_id;

SELECT SYS_CONTEXT('USERENV', 'CURRENT_SCHEMA') FROM dual;

SELECT "card_record" FROM card;

select
    c1_0.id,
    c1_0.card_brand,
    c1_0.card_img,
    c1_0.card_in_out_1,
    c1_0.card_in_out_2,
    c1_0.card_in_out_3,
    c1_0.card_name,
    c1_0.card_overseas,
    c1_0.card_record
from
    card c1_0;

ALTER TABLE CARD RENAME COLUMN "id" TO id;

ALTER TABLE BENEFIT RENAME COLUMN "id" TO id;

SELECT *
FROM CARD
WHERE CARD_BRAND LIKE '%BC%';

SELECT *
FROM BENEFIT
WHERE CARD_ID IN (
    SELECT ID FROM CARD WHERE CARD_BRAND LIKE '%BC%'
);

SELECT b.card_id
FROM benefit b
         LEFT JOIN card c ON b.card_id = c.id
WHERE c.id IS NULL;

SELECT c.id AS card_id, b.id AS benefit_id
FROM card c
         LEFT JOIN benefit b ON b.card_id = c.id
WHERE c.card_brand LIKE '%BC%'
ORDER BY c.id;

DROP SEQUENCE SEQ_CARD;

CREATE SEQUENCE SEQ_CARD
    START WITH 2386
    INCREMENT BY 1
    NOMAXVALUE
    NOCACHE;

CREATE TABLE CARD (
                      id              NUMBER CONSTRAINT pk_card PRIMARY KEY,
                      card_name       VARCHAR2(3000),
                      card_brand      VARCHAR2(3000),
                      card_in_out_1   VARCHAR2(3000),
                      card_in_out_2   VARCHAR2(3000),
                      card_in_out_3   VARCHAR2(3000),
                      card_img        VARCHAR2(3000),
                      card_record     VARCHAR2(3000),
                      card_overseas   VARCHAR2(3000)
);

CREATE TABLE BENEFIT (
                         id NUMBER PRIMARY KEY,
                         bnf_name VARCHAR2(3000),
                         bnf_content VARCHAR2(3000),
                         bnf_detail CLOB,
                         card_id NUMBER NOT NULL
);

ALTER TABLE BENEFIT
    ADD CONSTRAINT fk_benefit_card
        FOREIGN KEY (card_id) REFERENCES CARD(id)
            ON DELETE CASCADE;

SELECT * FROM CARD c ;
SELECT count(*) FROM card;
DROP TABLE card;
SELECT * FROM BENEFIT b ORDER BY b.id DESC;
SELECT count(*) FROM BENEFIT b;
SELECT card_record AS c_r FROM CARD ORDER BY C_R DESC;
DROP TABLE benefit;

SELECT column_name, data_type, data_length
FROM user_tab_columns
WHERE table_name = 'BENEFIT';

UPDATE card
SET card_record = '전월실적 없음'
WHERE card_record IS NULL;

SELECT id, card_record
FROM card
WHERE card_record IS NULL;

COMMIT ;

ALTER TABLE CARD
    ADD VIEW_COUNT NUMBER DEFAULT 0 NOT NULL;

SELECT *
FROM CARD
WHERE CARD_NAME LIKE '%나라사랑%';

UPDATE card
SET view_count = TRUNC(DBMS_RANDOM.VALUE(500, 100000))
WHERE view_count = 0;

COMMIT;

SELECT * FROM card ORDER BY view_count DESC;

UPDATE benefit
SET bnf_content = '혜택 없음'
WHERE bnf_content IS NULL
   OR bnf_content = '#NAME';

UPDATE benefit
SET bnf_detail = '혜택 없음'
WHERE bnf_detail IS NULL;

DROP SEQUENCE seq_member;

DROP TABLE MEMBER;

CREATE SEQUENCE SEQ_MEMBER
    START WITH 1
    INCREMENT BY 1
    NOCACHE
NOCYCLE;

CREATE TABLE MEMBER (
                        MEMBER_ID        NUMBER         PRIMARY KEY,
                        MEMBER_LOGIN_ID  VARCHAR2(100)  NOT NULL UNIQUE,
                        MEMBER_PW        VARCHAR2(200)  NOT NULL,
                        MEMBER_NAME      VARCHAR2(100)  NOT NULL,
                        MEMBER_ROLE      VARCHAR2(200)  DEFAULT 'USER'
                                  CHECK (MEMBER_ROLE IN ('USER', 'ADMIN'))
                                  NOT NULL,
                        MEMBER_EMAIL     VARCHAR2(200)  NOT NULL UNIQUE,
                        MEMBER_BIRTH     DATE           NOT NULL
);


CREATE OR REPLACE TRIGGER TRG_MEMBER_BI
BEFORE INSERT ON MEMBER
FOR EACH ROW
WHEN (NEW.MEMBER_ID IS NULL)
BEGIN
  :NEW.MEMBER_ID := SEQ_MEMBER.NEXTVAL;
END;
/

COMMIT;


-- 관리자 계정 (role = ADMIN)
INSERT INTO MEMBER (
    MEMBER_ID, MEMBER_LOGIN_ID, MEMBER_PW, MEMBER_NAME, MEMBER_EMAIL, MEMBER_BIRTH, MEMBER_ROLE
) VALUES (
             SEQ_MEMBER.NEXTVAL, 'admin', '1234', '관리자', 'admin@example.com', DATE '1990-01-01', 'ADMIN'
         );

SELECT * FROM MEMBER WHERE MEMBER_LOGIN_ID = 'admin';

-- 일반 회원 1
INSERT INTO MEMBER (
    MEMBER_ID, MEMBER_LOGIN_ID, MEMBER_PW, MEMBER_NAME, MEMBER_EMAIL, MEMBER_BIRTH, MEMBER_ROLE
) VALUES (
             SEQ_MEMBER.NEXTVAL, 'user1', '1234', '홍길동', 'user1@example.com', DATE '1995-03-15', 'USER'
         );

-- 일반 회원 2
INSERT INTO MEMBER (
    MEMBER_ID, MEMBER_LOGIN_ID, MEMBER_PW, MEMBER_NAME, MEMBER_EMAIL, MEMBER_BIRTH, MEMBER_ROLE
) VALUES (
             SEQ_MEMBER.NEXTVAL, 'user2', '1234', '김영희', 'user2@example.com', DATE '1998-07-20', 'USER'
         );

-- 일반 회원 3
INSERT INTO MEMBER (
    MEMBER_ID, MEMBER_LOGIN_ID, MEMBER_PW, MEMBER_NAME, MEMBER_EMAIL, MEMBER_BIRTH, MEMBER_ROLE
) VALUES (
             SEQ_MEMBER.NEXTVAL, 'user3', '1234', '이철수', 'user3@example.com', DATE '2000-12-05', 'USER'
         );

INSERT INTO CARD (
    ID, CARD_NAME, CARD_BRAND, CARD_IN_OUT_1, CARD_IN_OUT_2, CARD_IN_OUT_3,
    CARD_IMG, CARD_RECORD, CARD_OVERSEAS
) VALUES (
             CARD_SEQ.NEXTVAL, '함정카드', '유희왕', '마겸겸용 8,000', NULL, NULL,
             'https://api.card-gorilla.com:8080/storage/card/1/card_img/20083/1card.png',
             '전월실적 없음',
             NULL
         );

SELECT * FROM MEMBER;

UPDATE MEMBER
SET MEMBER_PW = '$2a$10$Hlyu6JZQFXcq0EoGRRifKub8P62H5p3jfgxvQzhcJDNJpThxdlUcu'
WHERE MEMBER_LOGIN_ID = 'admin';

SELECT * FROM CARD c WHERE c.CARD_NAME = '마법카드';

SELECT * FROM card ORDER BY card.ID DESC;

DELETE FROM CARD WHERE card.id = '16691';

CREATE SEQUENCE SEQ_BENEFIT
    START WITH 13754
    INCREMENT BY 1
    NOCACHE;

DROP SEQUENCE SEQ_BENEFIT;

SELECT * FROM BENEFIT b ORDER BY b.ID DESC;